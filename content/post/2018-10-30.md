---
title: 2つのE
date: 2018-10-30T00:00:00+09:00
draft: true
tags:
- トリログ
- tech
- 開発
description: ワタリログの作成を開始しました
keywords:
- 株式会社ワタリドリ
- wataridori inc.
- blog
- wtrdr
isCJKLanguage: true
# coverImage: /img/2018-05america/IMG_6922.JPG
# thumbnailImage: /img/2018-05america/IMG_6922.JPG
# thumbnailImagePosition: left
---

## 一つめのE : Elm

reactを1人でガリガリ書いていくのが疲れそうだったので、なんとなく従兄弟分のnuxtで作ろうかなとぼやいていたら悪魔からのささやきがあった。





「Elmわからんけど面白いよ」

とのこと。

調べたらまだそんなに事例もないことだしやってみるか。関数型で物を作り上げるまで頑張ったことはなかったし。

ということでフロントはElmで行こう。

フレームワークからのサポートはほぼ無さそうな気配もあるし、必要なものも込みで自作する覚悟で。


### とりあえずドキュメントを一読

```elm
perform : (a -> msg) -> Task Never a -> Cmd msg
Like I was saying in the Task documentation, just having a Task does not mean it is done. We must command Elm to perform the task:

import Time  -- elm install elm/time
import Task

type Msg
  = Click
  | Search String
  | NewTime Time.Posix

getNewTime : Cmd Msg
getNewTime =
  Task.perform NewTime Time.now
If you have worked through guide.elm-lang.org (highly recommended!) you will recognize Cmd from the section on The Elm Architecture. So we have changed a task like "make delicious lasagna" into a command like "Hey Elm, make delicious lasagna and give it to my update function as a Msg value."
```

これがよくわからんかったけど、

```
NewTime
<function> Time.Posix -> Msg
```

で

```
Time.now : Task x Posix
```

だからいいのか。


### 諦めるところと頑張るところ

SSRは一旦諦めておくか。結局のところ、elmの0.19だとサーバーサイドでレンダーするのはできなさそうだし、
やれる範囲だとするとjsがデータを準備してflagsとして渡すという機構の部分に初期データをサーバーサイドで渡す時に作り上げておけるかな。
ま、困ったらやるとしよう。

最終的にindex.htmlだけどっかのstrageからservingすればいいか。という結論。
ということでSPAになるが、やる気がある時にSSRになるように組み込みたいなぁ。というwillだけのこしておく。

頑張るのはもちろんelmなんだが、それ以外にもいままでやっていたweb開発関連の知識が使いにくいところもありそうだ。
css-moduleとかsvgとか主にデザイン周りかもしれないけど。。。

これelmと切り離して考えた方がいいかもしれないなぁという雰囲気がある。。。

ということで一旦css-moduleは考えず直接classを記載する感じで行こう。

### 詰まったところ

ここからはやっていて詰まったところを残しておこう。

#### svg

当初初期化のjsの時点で全svg読み込んで、それに反応してwebpackのloaderがbodyの直下に配置してくれるような仕組みにしていた。
が、ページ遷移するとsvgが吹っ飛んでsvgモジュールでuseしている箇所が対象を発見できなくて無限ループになる。ようなバグを踏み抜いて最終的にはsvg-to-elmというサイトにお世話になりつつ全部svgをelmに変えて流し込むことにした。残念。

#### ページ遷移

SPAとしてクライアントでページ遷移をするようにしたので、その辺りの取り回しがなんともelmっぽいというか独特。
一応内部でhistory API callしてURLの変更とその後の描画内容の変更が別途できるようになっているのでそれを使う。

```elm
route : Parser (Route -> a) a
route =
    oneOf
        [ map Home top
        , map Journey (s "journeys" </> string)
        ]


toRoute : Url.Url -> Route
toRoute url =
    Maybe.withDefault NotFound (parse route url)


toRoute2 : String -> Route
toRoute2 string =
    case Url.fromString string of
        Nothing ->
            NotFound

        Just url ->
            toRoute url

```

こんな感じ。


#### window scroll event

ボタンをある特定の位置までfixedにしておいて、その位置まできたら固定にする。
みたいなやつをやろうとしたらcssじゃどうにもならなさそうだったのでelmでどうにかできないかなと。

調べるとscroll eventはonで取れるらしいが、windowに対するscrollは取れなさそうだった。
これから最上段のdivをscroll可能にして・・・みたいなのでもいいのかもしれないがちょっと手間なので
portsのsubscriptionの仕組みを使ってどうにかする

jsサイド

```typescript
import { Elm } from "./Main";

import "../resources/css/index.css";

const app = Elm.Main.init();

window.addEventListener("scroll", e => {
  console.log(`in js: ${e.type}`);
  app.ports.onWindowScroll.send(e.type);
});
```

elmサイド

```elm
port onWindowScroll : (String -> msg) -> Sub msg

main : Program () Model Msg
main =
    Browser.application
        { init = init
        , onUrlChange = UrlChanged
        , onUrlRequest = LinkClicked
        , subscriptions = subscriptions
        , update = update
        , view = view
        }

subscriptions : Model -> Sub Msg
subscriptions model =
    onWindowScroll WindowScrolled

update msg model =
    case msg of
        WindowScrolled str ->
            let
                _ =
                    Debug.log "in elm: " str
            in
            ( model, Cmd.none )
```

こんな感じで発火できるようになったので細いのはelm側で制御しよう。
String型でなくてもいいか。。。













## 二つめのE : Elixir
